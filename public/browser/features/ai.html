<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axiom AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script type="module" src="https://md-block.verou.me/md-block.js"></script>
    <script src="../js/themeManager.js"></script>


    <style>
        body {
            margin: 0;
            padding: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--theme-tertiary);
            color: var(--theme-textPrimary);
            height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
        }

        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            padding: 8px;
            margin-bottom: 50px;
        }

        #chat-message-user {
            background-color: var(--theme-userMessage);
            color: var(--theme-textPrimary);
            border-radius: 12px;
            padding: 8px 12px;
            max-width: 90%;
            align-self: flex-end;
            word-wrap: break-word;
            text-wrap: break-word;
            font-size: 13px;
            line-height: 1.3;
        }

        #chat-message-ai {
            background-color: var(--theme-aiMessage);
            color: var(--theme-textSecondary);
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 90%;
            align-self: flex-start;
            text-wrap: break-word;
            font-size: 13px;
            line-height: 1.3;
        }

        #chat-message-user pre,
        #chat-message-ai pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: inherit;
            font-size: inherit;
        }

        #chat-controls {
            position: fixed;
            bottom: 15px;
            width: 100%;
            left: 8px;
            right: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        #content-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--theme-textSecondary);
            cursor: pointer;
            user-select: none;
            padding: 4px 8px;
            border-radius: 16px;
            transition: all 0.2s ease;
        }

        #content-toggle:hover {
            background-color: var(--theme-overlay);
        }

        #content-toggle input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 36px;
            height: 20px;
            background-color: var(--theme-surfaceLight);
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            outline: none;
            transition: background-color 0.2s ease;
        }

        #content-toggle input[type="checkbox"]:checked {
            background-color: var(--theme-accent);
        }

        #content-toggle input[type="checkbox"]:before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: var(--theme-textPrimary);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
        }

        #content-toggle input[type="checkbox"]:checked:before {
            transform: translateX(16px);
        }

        #content-toggle label {
            cursor: pointer;
            font-weight: 500;
        }

        #chat-controls input {
            width: 300px;
            padding: 10px;
            background-color: var(--theme-inputBackground);
            color: var(--theme-textPrimary);
            border: none;
            border-radius: 16px;
            outline: none;
            font-size: 13px;
        }

        #chat-controls input::placeholder {
            color: var(--theme-textMuted);
        }

        #chat-container::-webkit-scrollbar {
            width: 4px;
        }

        #chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        #chat-container::-webkit-scrollbar-thumb {
            background: var(--theme-textMuted);
            border-radius: 2px;
        }

        #chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--theme-textSecondary);
        }
    </style>
</head>

<body>
    <div id="chat-container">
        <div id="chat-message-ai">
            <md-block>
                How can I help you today?
            </md-block>
        </div>
    </div>

    <div id="chat-controls">
        <div id="content-toggle">
            <input type="checkbox" id="include-content" checked />
            <label for="include-content">Include page content</label>
        </div>
        <center>
            <input type="text" id="chat-input" placeholder="Type your message here" />
        </center>
    </div>


    <script>
        const api_key = "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" // no, this isn't my api key, so don't call me a dumbass for putting it here
        const endpoint = "../../openai/v1/chat/completions"
        let chat_history = []

        function send(message, role) {
            const div = document.createElement("div")
            div.id = `chat-message-${role}`
            div.classList.add(role)
            div.innerHTML = `<md-block>${message}</md-block>`

            document.getElementById("chat-container").appendChild(div)
        }

        // Betty, i really hope youre on my side
        async function stream(history) {
            try {
                const response = await fetch(endpoint, {
                    "headers": {
                        "authorization": "Bearer " + api_key,
                        "content-type": "application/json",
                    },
                    "body": JSON.stringify({
                        "messages": history,
                        "model": "moonshotai/kimi-k2-instruct-0905",
                        "temperature": 1,
                        "max_completion_tokens": 8192,
                        "top_p": 1,
                        "stream": true,
                        "stop": null,
                      
                    }),
                    "method": "POST",
                    "mode": "cors",
                    "credentials": "include"
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = "";

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        break;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    console.log("Stream chunk:", chunk);

                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const jsonData = JSON.parse(line.slice(6));
                                
                                if (jsonData.choices && jsonData.choices[0] && jsonData.choices[0].delta && jsonData.choices[0].delta.content) {
                                    const content = jsonData.choices[0].delta.content;
                                    fullResponse += content;
                                    console.log("Content delta:", content);
                                }
                                
                                if (jsonData.choices && jsonData.choices[0] && jsonData.choices[0].finish_reason === "stop") {
                                    console.log("Stream finished with reason:", jsonData.choices[0].finish_reason);
                                }
                            } catch (parseError) {
                                console.log("Could not parse JSON from line:", line);
                                console.log("Parse error:", parseError);
                            }
                        }
                    }
                }

                console.log("Full response:", fullResponse);
                return fullResponse;

            } catch (error) {
                // fallback to charbot (goated) endpoint
                const char = "https://charbot.ape3d.com/prompt?q=" + history[history.length - 1].content ;
                // it doesn't do streaming so we must just wait for the response
                return fetch(char).then((response) => response.text());
            }
        }

        document.getElementById("chat-input").addEventListener("keydown", async function (key) {
            if (key.code == "Enter") {
                const userMessage = document.getElementById("chat-input").value;
                const includeContent = document.getElementById("include-content").checked;

                let contentToInclude = "";
                if (includeContent) {
                    let x = localStorage.getItem("content");
                    if (x != null && x.trim() !== "") {
                        // truncate the content to 1000 characters
                        x = x.substring(0, 1000);
                        contentToInclude = "\nUtilize this web data to solve your problem if relevant: \n" + x;
                    }
                }

                const fullMessage = userMessage + contentToInclude;
                const temp_chat_history = [...chat_history];

                temp_chat_history.push({
                    "role": "user",
                    "content": fullMessage
                });

                chat_history.push({
                    "role": "user",
                    "content": fullMessage // Store full message for context
                });

                send(includeContent && contentToInclude ? userMessage + " (with page content)" : userMessage, "user");

                document.getElementById("chat-input").value = "";

                const response = await stream(temp_chat_history);

                if (response) {
                    chat_history.push({
                        "role": "assistant",
                        "content": response,
                    });
                    send(response, "ai");
                } else {
                    console.error("No response received from stream");
                    send("Sorry, there was an error processing your request.", "ai");
                }
            }
        })

    </script>

</body>

</html>